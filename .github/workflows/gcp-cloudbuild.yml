name: Deploy to GCP Cloud Run via Cloud Build

on:
  push:
    branches: [ main ]

jobs:
  cloud-build-deploy:
    name: Cloud Build & Cloud Run Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
        run: |
          if [ -z "$GCP_SA_KEY" ] || [ -z "$GCP_PROJECT" ]; then
            echo "Missing GCP_SA_KEY or GCP_PROJECT secret. Add them in repository settings."; exit 1;
          fi
          echo "$GCP_SA_KEY" > /tmp/gcloud-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcloud-key.json
          gcloud config set project "$GCP_PROJECT"
          gcloud --quiet components update

      - name: Submit Cloud Build
        env:
          _REGION: ${{ secrets.GCP_REGION || 'us-central1' }}
        run: |
          # Submit build using the included cloudbuild.yaml
          gcloud builds submit --config cloudbuild.yaml --substitutions=_REGION=${_REGION}
